name: RDP (CentOS 7)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: [self-hosted, linux, x64, centos7]
    timeout-minutes: 3600

    env:
      RDP_USER: RDP
      RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

    steps:
      - name: Update + EPEL
        run: |
          sudo yum clean all
          sudo yum -y update || true
          sudo yum -y install epel-release

      - name: Install XRDP + Desktop (Xfce)
        run: |
          sudo yum -y install xrdp xorgxrdp
          # Minimal Xfce (bazı repolarda grup adı fark edebilir)
          sudo yum -y groupinstall "Xfce" || true
          # Alternatif paketler
          sudo yum -y install xfce4-session xfce4-panel xfce4-terminal thunar || true

      - name: Create Desktop Session for user
        run: |
          set -e
          USERNAME="${RDP_USER}"
          PASS="${RDP_PASSWORD}"
          if [ -z "$PASS" ]; then
            PASS="$(tr -dc 'A-Za-z0-9!@#$%^&*()_+-=' </dev/urandom | head -c 20)"
          fi

          if id "$USERNAME" >/dev/null 2>&1; then
            echo "$USERNAME:$PASS" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASS" | sudo chpasswd
          fi

          sudo -u "$USERNAME" bash -lc 'echo "startxfce4" > ~/.Xclients && chmod +x ~/.Xclients'

          echo "RDP_PASSWORD=$PASS" >> $GITHUB_ENV

      - name: SELinux permissive (first run)
        run: |
          if command -v getenforce >/dev/null 2>&1; then
            sudo setenforce 0 || true
            sudo sed -ri 's/^SELINUX=enforcing/SELINUX=permissive/i' /etc/selinux/config || true
          fi

      - name: Open 3389 in firewalld
        run: |
          if systemctl is-active --quiet firewalld; then
            ZONE="$(firewall-cmd --get-default-zone || echo public)"
            sudo firewall-cmd --zone="$ZONE" --permanent --add-port=3389/tcp
            sudo firewall-cmd --reload
          fi

      - name: Enable + Start XRDP
        run: |
          sudo systemctl enable xrdp xrdp-sesman
          sudo systemctl restart xrdp xrdp-sesman
          systemctl status xrdp --no-pager || true
          systemctl status xrdp-sesman --no-pager || true

      - name: Install + Up Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable tailscaled
          sudo systemctl restart tailscaled
          if [ -z "${TAILSCALE_AUTH_KEY}" ]; then
            echo "TAILSCALE_AUTH_KEY missing"; exit 1
          fi
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="gh-centos7-${GITHUB_RUN_ID}" --accept-routes=true
          TS_IP="$(tailscale ip -4 | head -n1)"
          if [ -z "$TS_IP" ]; then
            echo "No Tailscale IP"; exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Print access + logs
        run: |
          echo "=== XRDP ==="
          echo "User: $RDP_USER"
          echo "Pass: $RDP_PASSWORD"
          echo "Tailscale: $TAILSCALE_IP:3389"
          echo "------------ Logs (last 100) ------------"
          tail -n 100 /var/log/xrdp.log || true
          tail -n 100 /var/log/xrdp-sesman.log || true

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date)] XRDP alive at $TAILSCALE_IP:3389 (user: $RDP_USER)"
            sleep 300
          done
